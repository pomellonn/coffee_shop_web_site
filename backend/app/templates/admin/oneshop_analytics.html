{% extends "sqladmin/layout.html" %} {% block title %}Аналитика одной кофейни{%
endblock %} {% block content %}
<div class="container-fluid">
  <div class="row mb-3">
    <div class="col-md-3">
      <label>ID кофейни</label>
      <input type="number" id="shop_id" class="form-control" />
    </div>
    <div class="col-md-3">
      <label>From</label>
      <input type="date" id="date_from" class="form-control" />
    </div>
    <div class="col-md-3">
      <label>To</label>
      <input type="date" id="date_to" class="form-control" />
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-primary" onclick="loadAnalytics()">
        Показать
      </button>
    </div>
  </div>

  <!-- Orders per day -->
  <!-- <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Количество заказов по дням</div>
        <div class="card-body">
          <table class="table table-bordered">
            <thead>
              <tr><th>Дата</th><th>Количество заказов</th></tr>
            </thead>
            <tbody id="orders-per-day-body"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <canvas id="orders-per-day-chart"></canvas>
    </div>
  </div> -->

  <!-- Monthly summary -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Аналитика по месяцам</div>
        <div class="card-body">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Месяц</th>
                <th>Количество заказов</th>
                <th>Выручка</th>
                <th>Средний чек</th>
              </tr>
            </thead>
            <tbody id="monthly-summary-body"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <canvas id="monthly-summary-chart"></canvas>
    </div>
  </div>

  <!-- Product ranking -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Рейтинг продуктов</div>
        <div class="card-body">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Продукт</th>
                <th>Продано (кол-во)</th>
                <th>Выручка</th>
              </tr>
            </thead>
            <tbody id="product-ranking-body"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <canvas id="product-chart"></canvas>
    </div>
  </div>

  <!-- Time period sales -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">Продажи по времени суток</div>
        <div class="card-body">
          <canvas id="time-period-chart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block tail %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  async function loadAnalytics() {
    const from = document.getElementById("date_from").value;
    const to = document.getElementById("date_to").value;
    const shop_id = document.getElementById("shop_id").value;

    if (!from || !to) {
      alert("Выберите диапазон дат");
      return;
    }

    let url = `/api/v1/admin/analytics/one-shop?date_from=${from}&date_to=${to}`;
    if (shop_id) url += `&shop_id=${shop_id}`;

    const response = await fetch(url);
    const result = await response.json();

    // // Orders per day
    // const ordersBody = document.getElementById("orders-per-day-body");
    // ordersBody.innerHTML = "";
    // const ordersLabels = [],
    //   ordersData = [];
    // result.orders_per_day.forEach((r) => {
    //   ordersBody.innerHTML += `<tr><td>${r.date}</td><td>${r.count_of_orders}</td></tr>`;
    //   ordersLabels.push(r.date);
    //   ordersData.push(r.count_of_orders);
    // });
    // const ctxDay = document
    //   .getElementById("orders-per-day-chart")
    //   .getContext("2d");
    // if (window.ordersChart) window.ordersChart.destroy();
    // window.ordersChart = new Chart(ctxDay, {
    //   type: "line",
    //   data: {
    //     labels: ordersLabels,
    //     datasets: [
    //       {
    //         label: "Заказы",
    //         data: ordersData,
    //         borderColor: "blue",
    //         backgroundColor: "rgba(54,162,235,0.2)",
    //       },
    //     ],
    //   },
    //   options: { scales: { y: { beginAtZero: true } } },
    // });

    // Monthly summary
    const monthlyBody = document.getElementById("monthly-summary-body");
    monthlyBody.innerHTML = "";
    const monthLabels = [],
      ordersMonth = [],
      revenueMonth = [],
      avgCheckMonth = [];
    result.monthly_summary.forEach((r) => {
      monthlyBody.innerHTML += `<tr><td>${r.month}</td><td>${
        r.orders_count
      }</td><td>${r.revenue.toFixed(2)}</td><td>${r.avg_check.toFixed(
        2
      )}</td></tr>`;
      monthLabels.push(r.month);
      ordersMonth.push(r.orders_count);
      revenueMonth.push(r.revenue);
      avgCheckMonth.push(r.avg_check);
    });
    const ctxMonth = document
      .getElementById("monthly-summary-chart")
      .getContext("2d");
    if (window.monthlyChart) window.monthlyChart.destroy();
    window.monthlyChart = new Chart(ctxMonth, {
      type: "bar",
      data: {
        labels: monthLabels,
        datasets: [
          {
            label: "Заказы",
            data: ordersMonth,
            backgroundColor: "rgba(54,162,235,0.6)",
          },
          {
            label: "Выручка",
            data: revenueMonth,
            backgroundColor: "rgba(255,99,132,0.6)",
          },
        ],
      },
      options: { scales: { y: { beginAtZero: true } } },
    });

    // Product ranking
    const productBody = document.getElementById("product-ranking-body");
    productBody.innerHTML = "";
    const productLabels = [],
      totalsoldProduct = [],
      revenueProduct = [];
    result.product_ranking.forEach((r) => {
      productBody.innerHTML += `<tr><td>${r.product}</td><td>${
        r.total_sold
      }</td><td>${r.revenue.toFixed(2)}</td></tr>`;
      productLabels.push(r.product);
      totalsoldProduct.push(r.total_sold);
      revenueProduct.push(r.revenue);
    });
    const barproduct = document
      .getElementById("product-chart")
      .getContext("2d");
    if (window.productChart) window.productChart.destroy();
    window.productChart = new Chart(barproduct, {
      type: "bar",
      data: {
        labels: productLabels,
        datasets: [
          {
            label: "Продано (кол-во)",
            data: totalsoldProduct,
            backgroundColor: "rgba(54,162,235,0.6)",
          },
          {
            label: "Выручка",
            data: revenueProduct,
            backgroundColor: "rgba(255,99,132,0.6)",
          },
        ],
      },
      options: { scales: { y: { beginAtZero: true } } },
    });

    // Time period sales
    const timeLabels = [],
      timeData = [];
    result.time_period_sales.forEach((r) => {
      timeLabels.push(r.period);
      timeData.push(r.orders);
    });
    const ctxTime = document
      .getElementById("time-period-chart")
      .getContext("2d");
    if (window.timeChart) window.timeChart.destroy();
    window.timeChart = new Chart(ctxTime, {
      type: "pie",
      data: {
        labels: timeLabels,
        datasets: [
          {
            data: timeData,
            backgroundColor: ["#FFCE56", "#36A2EB", "#FF6384"],
          },
        ],
      },
    });
  }
</script>
{% endblock %}
